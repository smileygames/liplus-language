name: Li+ Auto Issue Comment (Lin)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  auto-reply:
    runs-on: ubuntu-latest
    steps:
      - name: Lin auto reply via OpenAI
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;

            // Whitelist
            if (issue.number !== 100) return;

            // Avoid endless self-trigger by Lin
            if ((comment.body || '').startsWith('Lin:')) return;

            const prompt = `You are Lin.\nRespond concisely and constructively.\n\nLatest comment:\n${comment.body}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  { role: 'system', content: 'You are Lin, an autonomous agent participating in a GitHub Issue discussion.' },
                  { role: 'user', content: prompt }
                ]
              })
            });

            const data = await response.json();
            const text = data.choices?.[0]?.message?.content || 'Lin: (no response)';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Lin: ${text}`,
            });
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
