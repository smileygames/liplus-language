name: Generate Full Changelog from PR and Issue bodies

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  full-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Generate CHANGELOG.full.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -e

          echo "# Full Change Log" > CHANGELOG.full.md
          echo "" >> CHANGELOG.full.md
          echo "Release: $TAG" >> CHANGELOG.full.md
          echo "" >> CHANGELOG.full.md

          # 直前の正式リリースタグを取得（draft / prerelease を除外）
          PREV_TAG=$(gh api repos/$REPO/releases \
            --jq '[.[] | select(.draft == false and .prerelease == false)][1].tag_name')

          # 前回リリースが存在しない場合は正常終了
          if [ -z "$PREV_TAG" ]; then
            echo "No previous release found. Skipping changelog generation."
            exit 0
          fi

          # タグ差分からコミットメッセージを取得
          COMMITS=$(gh api repos/$REPO/compare/${PREV_TAG}...${TAG} \
            --jq '.commits[].commit.message')

          # PR番号を抽出（Merge PR / (#123) 両対応）
          PRS=$(echo "$COMMITS" \
            | grep -oE '(#|pull request )([0-9]+)' \
            | grep -oE '[0-9]+' \
            | sort -u)

          for PR in $PRS; do
            TITLE=$(gh api repos/$REPO/pulls/$PR --jq '.title')
            BODY=$(gh api repos/$REPO/pulls/$PR --jq '.body')

            echo "## $TITLE (#$PR)" >> CHANGELOG.full.md
            echo "" >> CHANGELOG.full.md
            echo "$BODY" >> CHANGELOG.full.md
            echo "" >> CHANGELOG.full.md

            # PR本文内の Refs #<issue> を検出
            ISSUES=$(echo "$BODY" \
              | grep -oE 'Refs #[0-9]+' \
              | grep -oE '[0-9]+' \
              | sort -u)

            for ISSUE in $ISSUES; do
              echo "### Issue #$ISSUE" >> CHANGELOG.full.md
              echo "" >> CHANGELOG.full.md
              gh api repos/$REPO/issues/$ISSUE --jq '.body' >> CHANGELOG.full.md
              echo "" >> CHANGELOG.full.md
            done
          done

      - name: Upload CHANGELOG.full.md to release
        uses: softprops/action-gh-release@v1
        with:
          files: CHANGELOG.full.md
