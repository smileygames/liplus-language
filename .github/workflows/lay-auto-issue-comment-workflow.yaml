name: Lay Auto Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  lay-auto-reply:
    runs-on: ubuntu-latest
    steps:
      - name: Lay auto reply via OpenAI
        uses: actions/github-script@v7
        with:
          script: |
            throw new Error("LAY WORKFLOW STARTED");
            const issue = context.payload.issue;
            const comment = context.payload.comment;

            // 対象 Issue 制限
            if (issue.number !== 100) return;

            const body = comment.body || "";

            // 自分自身（Lay）の発言は無視
            if (body.startsWith("Lay:")) return;

            const prompt = [
              "You are Lay.",
              "Your role is to observe, analyze, and structure the discussion.",
              "Summarize key points or highlight inconsistencies.",
              "",
              "Latest comment:",
              body
            ].join("\n");

            const response = await fetch(
              "https://api.openai.com/v1/chat/completions",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer " + process.env.OPENAI_API_KEY
                },
                body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [
                    {
                      role: "system",
                      content: "You are Lay, an autonomous analytical observer in a GitHub Issue discussion."
                    },
                    {
                      role: "user",
                      content: prompt
                    }
                  ]
                })
              }
            );

            const data = await response.json();
            const text =
              data.choices &&
              data.choices[0] &&
              data.choices[0].message &&
              data.choices[0].message.content
                ? data.choices[0].message.content
                : "(no response)";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: "Lay: " + text
            });
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
