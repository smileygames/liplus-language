name: li-ci

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  observe:
    runs-on: ubuntu-latest
    steps:
      - name: Observe Issue reference (Li+ observation)
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;

            // PR以外(push等)でも落ちないように
            let title = "";
            let body = "";
            if (event === "pull_request" && context.payload.pull_request) {
              title = context.payload.pull_request.title || "";
              body  = context.payload.pull_request.body  || "";
            }

            const text = title + "\n" + body;

            const patterns = [
              /#\d+/,
              /GH-\d+/i,
              /Issue:\s*\S+/i
            ];

            let detected = "none";
            for (const re of patterns) {
              const m = text.match(re);
              if (m) { detected = m[0]; break; }
            }

            const present = detected !== "none";

            core.notice(`Li+ Observation: issue_ref_present=${present}, detected_issue_ref=${detected}`);

            // Step Summaryに出す（バッククォート不使用）
            await core.summary
              .addHeading("Li+ CI Observation")
              .addList([
                "Event: " + event,
                "Issue reference present: " + present,
                "Detected reference: " + detected
              ])
              .addHeading("Notes", 2)
              .addList([
                "This workflow is observation-only.",
                "No enforcement or failure is performed.",
                "Results are recorded as evidence only."
              ])
              .write();
