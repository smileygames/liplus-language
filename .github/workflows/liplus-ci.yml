name: Liplus Governance CI

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, edited]

jobs:
  governance:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read

    steps:

      - name: Validate Commit Message
        if: github.event_name == 'push'
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          TITLE=$(echo "$COMMIT_MESSAGE" | head -n1)
          BODY=$(echo "$COMMIT_MESSAGE" | tail -n +2)

          # ASCII title
          if echo "$TITLE" | grep -P '[^\x00-\x7F]' ; then
            echo "Commit title must be ASCII."
            exit 1
          fi

          # Japanese body
          if ! echo "$BODY" | grep -P '[ぁ-んァ-ン一-龥]' ; then
            echo "Commit body must contain Japanese."
            exit 1
          fi

          # Issue reference
          if ! echo "$BODY" | grep -E '#[0-9]+' ; then
            echo "Commit body must contain issue number."
            exit 1
          fi


      - name: Validate Pull Request
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # ASCII title
          if echo "$PR_TITLE" | grep -P '[^\x00-\x7F]' ; then
            echo "PR title must be ASCII."
            exit 1
          fi

          # Japanese body
          if ! echo "$PR_BODY" | grep -P '[ぁ-んァ-ン一-龥]' ; then
            echo "PR body must contain Japanese."
            exit 1
          fi

          # Issue reference
          if ! echo "$PR_BODY" | grep -E '#[0-9]+' ; then
            echo "PR body must reference issue number."
            exit 1
          fi


      - name: Validate Issue
        if: github.event_name == 'issues'
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # ASCII title
          if echo "$ISSUE_TITLE" | grep -P '[^\x00-\x7F]' ; then
            echo "Issue title must be ASCII."
            exit 1
          fi

          # Japanese body
          if ! echo "$ISSUE_BODY" | grep -P '[ぁ-んァ-ン一-龥]' ; then
            echo "Issue body must contain Japanese."
            exit 1
          fi


      - name: Notify Issue on CI Result
        if: always() && github.event_name == 'pull_request' && github.event.action != 'closed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
        run: |
          ISSUE=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          [ -z "$ISSUE" ] && exit 0
          SHORT_SHA="${PR_SHA:0:7}"
          if [ "$JOB_STATUS" = "success" ]; then
            gh issue comment "$ISSUE" -R "$REPO" \
              --body "CI passed ✓ \`${SHORT_SHA}\` PR #${PR_NUMBER}"
          else
            gh issue comment "$ISSUE" -R "$REPO" \
              --body "CI failed ✗ \`${SHORT_SHA}\` PR #${PR_NUMBER}"
          fi


      - name: Notify Issue on Review Approval
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REVIEWER: ${{ github.event.review.user.login }}
          REPO: ${{ github.repository }}
        run: |
          ISSUE=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          [ -z "$ISSUE" ] && exit 0
          gh issue comment "$ISSUE" -R "$REPO" \
            --body "approved by @${REVIEWER} PR #${PR_NUMBER}"


      - name: Notify Issue on Merge
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
          REPO: ${{ github.repository }}
        run: |
          ISSUE=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          [ -z "$ISSUE" ] && exit 0
          gh issue comment "$ISSUE" -R "$REPO" \
            --body "merged to main by @${MERGED_BY} PR #${PR_NUMBER}"

