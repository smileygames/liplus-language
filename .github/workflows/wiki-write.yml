name: Li+ Wiki Write (Issue #94 Trigger)

on:
  workflow_dispatch:
    inputs:
      wiki_file:
        description: "Wiki page filename (e.g. today.md)"
        required: true
      content_base64:
        description: "Base64 encoded markdown content"
        required: true
      commit_message:
        description: "Commit message"
        required: true

jobs:
  wiki-write:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Wiki repo を Classic PAT で checkout
      - name: Checkout Wiki repository
        uses: actions/checkout@v4
        with:
          repository: smileygames/liplus-language.wiki
          token: ${{ secrets.WIKI_PAT }}
          persist-credentials: true

      # 2️⃣ リモートを基準にブランチを作り直す（non-fast-forward 対策）
      - name: Create or reset branch
        run: |
          git fetch origin
          git checkout -B feature/wiki-actions origin/feature/wiki-actions || git checkout -B feature/wiki-actions

      # 3️⃣ Wiki ファイルを書き込む
      - name: Write Wiki file
        run: |
          echo "${{ inputs.content_base64 }}" | base64 --decode > "${{ inputs.wiki_file }}"

      # 4️⃣ commit & push
      - name: Commit and push
        run: |
          git config user.name "Li+ Bot"
          git config user.email "li-plus@users.noreply.github.com"

          git add .
          git commit -m "[Li+ Wiki Write] ${{ inputs.commit_message }}" || echo "No changes to commit"
          git push origin feature/wiki-actions
