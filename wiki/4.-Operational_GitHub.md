# GitHub 運用ルール（Li+）

このページは、Li+ プロジェクトにおける **GitHub
上での実際の運用規則**を定義する。

ここに書かれている内容は思想や方針ではなく、
**守られない場合にレビュー・修正・差し戻しの対象となる規則**である。

------------------------------------------------------------------------

## ラベル定義

### ライフサイクルラベル

| ラベル | 意味 |
|-------|------|
| `in-progress` | 着手中、実装または検証が進行中 |
| `backlog` | 受け入れ済み、着手時期未定 |
| `deferred` | 今回対応しない。あとで見直す。 |
| `done` | 完了・マージ済み。追跡用に保持 |

### タイプラベル

| ラベル | 意味 |
|-------|------|
| `bug` | 動いていない、壊れている |
| `enhancement` | 新機能・改善要望 |
| `spec` | Li+の挙動に影響する仕様・ポリシー・定義 |

- ラベルはAIが読むための英単語、説明文は人間用の日本語
- 作成時は必ず説明文を書く
- ラベルは運用の中で進化する

------------------------------------------------------------------------

## Issue / Commit / Pull Request 共通ルール

-   すべての作業は **Issue から始める**
-   Commit / Pull Request は **必ず Issue に紐づける**
-   Issue 番号のない Commit / PR は認めない
-   **関係のない Issue を流用してはならない**（必ず新規作成する）

------------------------------------------------------------------------

## Issue の記述

-   Issue は「要求の置き場」である
-   正解や実装方法を書く必要はない
-   以下を含めることを推奨する
    -   目的
    -   前提
    -   制約
    -   完了条件（曖昧でもよい）

### チェックリストと sub-issue の使い分け

-   **sub-issue** = AI が追跡・実行できる作業単位。open/closed で完了を管理する
-   **チェックリスト** = 人間の判断が必要なもの（実機テスト、運用確認など）

Li+ では完了条件を sub-issue の状態で管理できるため、チェックリストは原則不要。
チェックリストを使うのは「AI が判定できない、人間が目で確認する必要があるもの」に限る。

------------------------------------------------------------------------

## Issue / Commit / Pull Request の形式

### Title（必須）

-   **英語**
-   **ASCII のみ**
-   **1行**
-   識別層として扱う（意味説明を含めない）

### Body（必須）

-   **日本語**
-   意味層として扱う（背景・判断・意図を記述する）
-   変更内容の要約・判断理由・**Issue 番号**を含めること

### Issue 番号の記述形式

```
Refs #159
```

-   `Refs #xxx` 形式を使う（形式が明確であれば他の表現も可）
-   PR本文に Issue 番号が含まれていると、**マージ時に GitHub が Issue を自動クローズする**

### 言語レイヤー分離原則

-   Title は識別レイヤー（ASCII 英語）
-   Body は意味レイヤー（日本語）
-   日本語タイトル・英語のみの Body は禁止

------------------------------------------------------------------------

## Pull Request 追加ルール

-   **2～3行で要約を書く**
-   変更の要点と影響範囲が分かること
-   詳細説明は不要（Issue を参照する）

------------------------------------------------------------------------

## ブランチ運用ルール

### ブランチ作成のタイミング（タイミング三段階）

着手意思は対話の空気から判断する。チェックリストで確認しない。

| タイミング | ラベル | ブランチ |
|----------|-------|--------|
| NOW（今やる） | `in-progress` | 作成する |
| SOON（近いうち） | `backlog` | 作成しない |
| SOMEDAY（いつか） | `deferred` | 作成しない |

### ブランチ命名規則

Claude Code のセッションブランチをそのまま使用する。

```
claude/{task-description-SessionID}
# 例: claude/add-character-dialogue-ZKjl4
```

作成コマンド（Issue へのリンクを必ず張る）：

```
gh issue develop {issue_number} -R {owner}/{repo} --name {session-branch} --base main
```

> **順序制約**: `gh issue develop` は **GitHub への初回 push より前に実行する**。
> すでに **GitHub 上にブランチが存在する場合**、後から実行してもリンクは張れない。

### 作業開始時の Assignee ルール

```
gh api repos/{owner}/{repo}/issues/{issue_number}/assignees \
  --method POST \
  -f 'assignees[]=liplus-lin-lay'
```

### sub-issue のブランチルール

-   **sub-issue にはブランチを作らない**
-   ブランチを持つのは「実際に PR を出す作業単位（親 issue）」だけ
-   セッションブランチは **親 issue** にリンクする
-   複数の子 issue の作業を同じセッションブランチで進めてよい（commit で issue 番号を複数参照）

### 同時タスクの場合は親子 issue を使う

複数タスクを同一セッションで並行進行する場合、issue を個別に作成すると **ブランチリンクは最初の 1 件にしか張れない**（GitHub 制約）。

正しい構造：

```
親 issue  ← gh issue develop でブランチリンク
├── 子 issue A  （責務 A の作業）
├── 子 issue B  （責務 B の作業）
└── 子 issue C  （責務 C の作業）
```

-   親 issue の body にはタスク全体の目的と子 issue 一覧を簡潔に書く
-   詳細な完了条件は各子 issue に書く
-   commit body には対応する子 issue 番号を `Refs #xxx` で参照する

### 親 issue のクローズ条件

-   子 issue（deferred 扱いのものを除く）がすべてクローズされたら親をクローズする
-   子 issue が残っている状態で親をクローズしない

------------------------------------------------------------------------

## マージフロー

**CI PASS かつ構造レビューで問題がなければ、実機テストより前にマージしてよい。**

```
gh pr merge {pr_number} -R {owner}/{repo} --squash --delete-branch
```

- squash merge を使用（merge commit は禁止）

### `--delete-branch` の使用条件と推奨フロー

**推奨フロー：子 issue を全てクローズしてから PR を作成・マージする。**
これにより `--delete-branch` をマージと同時に実行でき、ブランチ残存を防ぐ。

```
# 推奨順序
# 1. 子 issue を全てクローズ
# 2. 親 issue をクローズ
# 3. PR 作成
# 4. マージ（--delete-branch 付き）
gh pr merge {pr_number} -R {owner}/{repo} --squash --delete-branch
```

セッションブランチが **open な親 issue にリンクされている間は `--delete-branch` 禁止**。
やむを得ずマージを先行させた場合は、全 issue クローズ後に手動でブランチを削除すること。

> ブランチを削除すると、`gh issue develop` でリンクされた open issue が**自動クローズ**される。
> 誤ってクローズした場合は `gh issue reopen {number} -R {owner}/{repo}` で再オープンすること。

> **将来課題**: 推奨フローはコードのマージと issue のクローズを同期させる制約になる。
> 「コードは完成しているが issue はまだ議論中」といったケースでは窮屈になる可能性があり、
> 柔軟な対応は将来の検討事項とする。

------------------------------------------------------------------------

## 人間確認が必要な操作

以下の操作は **必ず人間に確認してから実行する**：

-   リリース作成（バージョン種別とターゲットタグ）
-   ブランチ削除（リンクされた issue がクローズされる可能性がある場合）
-   force push

### バージョン種別ルール

| バージョン | 適用条件 |
|----------|--------|
| patch | バグ修正・設定・ルール変更 |
| minor | 新機能・動作変更 |
| major | 破壊的変更・仕様非互換 |

**バージョン種別の判断は人間が行い、AIは実行のみを担う。**

### リリースタグルール

-   **CD が作成したスナップショットタグ（`build-YYYY-MM-DD.N`）を使う**
-   新規タグを作成してリリースを作ってはならない
-   コマンド例：`gh release create build-2026-02-25.14 --title "Li+ v0.13.1" --prerelease`

### リリース body ルール

-   **body は空にする**（内容を書かない）
-   body を空にすることで GitHub がコミット一覧を自動表示する——これは意図した動作

### 停止ルール

「待って」「止めて」「まって」と言われたら即座に停止する。

------------------------------------------------------------------------

## GitHub への書き込みルール

### プライマリ：git push（推奨）

```
git push origin {session-branch}
```

### フォールバック：GitHub API（git 非使用環境）

git が使えない環境や、他の AI エージェントとの互換性が必要な場合に使用する。

> **注意（複数ファイル時）**: tree 作成後、コミット前にファイル数を検証すること。
> `base_tree` のファイル数より減少していた場合はコミット中止。

------------------------------------------------------------------------

## CI ループフロー

**PR 作成直後に自動起動する。人間の指示は不要。**

1.  **PR 作成・更新時**
    -   タイトルは ASCII 英語、本文は日本語 + Issue 番号必須
    -   作成と同時に CI ループを開始する
2.  **コミットチェックランのポーリング**
    -   最新コミット SHA を取得
    -   全て `completed` になるまで待機
3.  **結論判定**
    -   `conclusion=failure` がある場合 → CI FAIL
    -   全て `success` の場合 → CI PASS
4.  **CI FAIL 時の自動修正ループ（Loop_Safety タスク閾値=3回）**
    -   同一の修正アプローチを3回繰り返したら中止・アプローチ切り替え
    -   収束しない場合は自動修正を停止し、Issue にコメントとして外部化して人間に委ねる

------------------------------------------------------------------------

## sub-issue 操作ルール

### sub-issue API の内部 ID

`sub_issue_id` には **issue 番号ではなく内部 ID** が必要。

```
# 内部 ID の取得
gh api repos/{owner}/{repo}/issues/{number} --jq '.id'

# sub-issue の追加
gh api repos/{owner}/{repo}/issues/{parent_number}/sub_issues \
  --method POST \
  -f sub_issue_id={internal_id}
```

タイミング制約はない（issue 作成後でも追加可能）。

### 子 issue の分割原則

-   **責務で分ける**（粒度で分けない）
-   オブジェクト指向と同じ考え方：同じ責務なら1つの issue にまとめる
-   複数ファイルにまたがっていても責務が同じなら1つでよい
-   **解釈でずれる構造は間違った構造**——正しく読めるかどうかが解釈に依存するなら構造を見直すこと

------------------------------------------------------------------------

## 禁止事項

-   Issue に紐づかない Commit / PR
-   関係のない Issue を流用してブランチを作ること
-   日本語タイトルの Commit / PR
-   Issue 番号の記載がない Commit / PR
-   Pull Request の要約が無いもの
-   言語レイヤー分離に違反するもの
-   着手前にブランチを作成すること
-   作業開始時に Assignee を設定しないこと
-   open な子 issue が残っている状態で `--delete-branch` 付きマージをすること
-   人間確認なしにリリースを作成すること
