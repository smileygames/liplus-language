# GitHub 運用ルール（Li+）

このページは、Li+ プロジェクトにおける **GitHub
上での実際の運用規則**を定義する。

ここに書かれている内容は思想や方針ではなく、
**守られない場合にレビュー・修正・差し戻しの対象となる規則**である。

------------------------------------------------------------------------

## Issue / Commit / Pull Request 共通ルール

-   すべての作業は **Issue から始める**
-   Commit / Pull Request は **必ず Issue に紐づける**
-   Issue 番号のない Commit / PR は認めない

------------------------------------------------------------------------

## ブランチ運用ルール

### ブランチ作成のタイミング

-   Issue は作業予定に関わらず作成してよい
-   ブランチは **着手直前** にのみ作成する
-   Issue ごとにブランチを即作成するとサブブランチが乱立するため

### ブランチ命名規則

GitHub の「Create a branch for this issue」形式を使う。
Issue へのリンクが自動付与される。

```
{issue-number}-{issue-title-slugified}
# 例: 317-update-lay_presentation-add-natural-attribute
```

作成コマンド：

```
gh issue develop {issue_number} -R {owner}/{repo} --name {branch-name} --base main
```

> セッション（AI）が内部的に `claude/xxx` 形式のブランチ名を持っていても、
> GitHub 上では使用しない。必ず Issue リンクブランチを作成し、そこで作業する。

### 作業開始時の Assignee ルール

ブランチ作成（着手直前）と同時に、Issue の Assignee を `liplus-lin-lay` に変更する。
Assignee により「誰が担当中か」が明示され、並行作業の衝突を防ぐ。

```
gh api repos/{owner}/{repo}/issues/{issue_number}/assignees \
  --method POST \
  -f 'assignees[]=liplus-lin-lay'
```

------------------------------------------------------------------------

## Issue の記述

-   Issue は「要求の置き場」である
-   正解や実装方法を書く必要はない
-   以下を含めることを推奨する
    -   目的
    -   前提
    -   制約
    -   完了条件（曖昧でもよい）

------------------------------------------------------------------------

## Issue / Commit / Pull Request の形式

### Title（必須）

-   **英語**
-   **ASCII のみ**
-   **1行**
-   識別層として扱う（意味説明を含めない）

例：

```
Add placement rules to Li+ index
```

### Body（必須）

-   **日本語**
-   将来的な多言語化は許容するが、現時点では日本語を基本とする
-   意味層として扱う（背景・判断・意図を記述する）
-   以下を含めること
    -   変更内容の要約
    -   判断理由や背景（あれば）

------------------------------------------------------------------------

### 言語レイヤー分離原則（LANGUAGE_LAYER_SEPARATION）

-   Title は **識別レイヤー（ASCII 英語）**
-   Body は **意味レイヤー（日本語）**
-   識別と意味を混在させない
-   日本語タイトルは禁止
-   英語のみのBodyは禁止

------------------------------------------------------------------------

### Issue 番号（必須）

-   Commit / PR のbodyに **必ず Issue 番号を含める**
-   形式は自由だが、Issue との関連が明確であること

例：

```
Refs #159
```

------------------------------------------------------------------------

## Pull Request 追加ルール

### Pull Request Body の要約（必須）

-   **2～3行で要約を書く**
-   変更の要点と影響範囲が分かること
-   詳細説明は不要（Issue を参照する）

------------------------------------------------------------------------

## GitHub への書き込みルール

**すべての GitHub への書き込みは GitHub API 経由で行う。**
git push（ローカルプロキシ経由）は禁止。

### 単一ファイルのコミット

```
gh api repos/{owner}/{repo}/contents/{path} \
  --method PUT \
  -f message="{commit message}" \
  -f content="{base64-encoded-content}" \
  -f branch="{branch-name}" \
  -f sha="{current-file-sha}"
```

### 複数ファイルのコミット

```
# Step 1: ファイルごとに blob を作成
gh api repos/{owner}/{repo}/git/blobs \
  --method POST \
  -f content="{base64-encoded-content}" \
  -f encoding="base64"

# Step 2: tree を作成（全 blob をまとめる）
gh api repos/{owner}/{repo}/git/trees \
  --method POST \
  -f base_tree="{base-tree-sha}" \
  --field "tree[0][path]={file-path}" \
  --field "tree[0][mode]=100644" \
  --field "tree[0][type]=blob" \
  --field "tree[0][sha]={blob-sha}"

# Step 3: commit を作成
gh api repos/{owner}/{repo}/git/commits \
  --method POST \
  -f message="{commit message}" \
  -f tree="{tree-sha}" \
  -f "parents[]={parent-commit-sha}"

# Step 4: ブランチの ref を更新
gh api repos/{owner}/{repo}/git/refs/heads/{branch} \
  --method PATCH \
  -f sha="{new-commit-sha}"
```

------------------------------------------------------------------------

## 禁止事項

-   Issue に紐づかない Commit / PR
-   日本語タイトルの Commit / PR
-   Issue 番号の記載がない Commit / PR
-   Pull Request の要約が無いもの
-   言語レイヤー分離に違反するもの
-   着手前にブランチを作成すること
-   作業開始時に Assignee を設定しないこと
-   git push（ローカルプロキシ経由）による書き込み

------------------------------------------------------------------------

## CI 自動コメントフロー

**PR 作成直後に自動起動する。人間の指示は不要。**

1.  **PR 作成・更新時**
    -   タイトルは ASCII 英語、本文は日本語 + Issue 番号必須
    -   作成と同時に CI ループを開始する
2.  **コミットチェックランのポーリング**
    -   最新コミット SHA を取得
    -   全て `completed` になるまで待機
3.  **結論判定**
    -   `conclusion=failure` がある場合 → CI FAIL
    -   全て `success` の場合 → CI PASS
4.  **自動コメント投稿**
    -   PR にコメントとして投稿
    -   コメント内容には:
        -   CI 結果（PASS/FAIL）
        -   コミット SHA
        -   PR URL
5.  **CI FAIL 時の自動修正ループ（ループ安全制約付き）**
    -   修正を試みて新規コミットで CI を再実行
    -   同一の修正アプローチを3回繰り返したら中止する
    -   別のアプローチに切り替える（方針・対象箇所を変える）
    -   それでも収束しない場合は自動修正を停止する
    -   強制的な結論を出さない
    -   未解決状態を **Issue** にコメントとして外部化し、人間に判断を委ねる

この自動化フローにより、**PR 作成から CI 結果の確認・修正までが人間の介入なしに実行**される。
ただし、ループ安全制約に達した場合は自動停止し、人間のメンテナーへエスカレーションする。
